import React, { useState, useEffect, useRef } from 'react';
import { TrendingUp, TrendingDown, DollarSign, PieChart as PieIcon, Calendar, Edit2, Save, Plus, Trash2, Calculator, Layers, Sparkles, Volume2, StopCircle, Loader, RefreshCw } from 'lucide-react';

// Google Material Colors
const COLORS = {
  blue: '#4285F4',
  red: '#EA4335',
  yellow: '#FBBC05',
  green: '#34A853',
  gray: '#F1F3F4',
  darkGray: '#5F6368',
  white: '#FFFFFF',
  text: '#202124'
};

// --- 請在此填入您的 GAS Web App URL ---
const API_URL = ""; 
// 例如: "https://script.google.com/macros/s/AKfycbx.../exec"

const PortfolioTracker = () => {
  // 模擬當前日期
  const today = new Date();
  const dateStr = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
  const weekDay = ['日', '一', '二', '三', '四', '五', '六'][today.getDay()];

  // Gemini API Key (由執行環境注入)
  const apiKey = ""; 

  // --- State ---
  const [loading, setLoading] = useState(false); // 全域讀取狀態
  const [syncing, setSyncing] = useState(false); // 背景同步狀態

  const STORAGE_KEYS = {
    apiUrl: 'stock_recording_api_url',
    sheetUrl: 'stock_recording_sheet_url'
  };

  const getStoredValue = (key, fallback = "") => {
    try {
      return localStorage.getItem(key) || fallback;
    } catch (error) {
      console.warn("LocalStorage Error:", error);
      return fallback;
    }
  };

  const [apiUrlInput, setApiUrlInput] = useState(() => getStoredValue(STORAGE_KEYS.apiUrl, API_URL));
  const [sheetUrlInput, setSheetUrlInput] = useState(() => getStoredValue(STORAGE_KEYS.sheetUrl, ""));
  const [apiUrlSetting, setApiUrlSetting] = useState(() => getStoredValue(STORAGE_KEYS.apiUrl, API_URL));
  const [sheetUrlSetting, setSheetUrlSetting] = useState(() => getStoredValue(STORAGE_KEYS.sheetUrl, ""));

  // 預設資料 (在讀取完成前顯示，或讀取失敗時的備案)
  const [cash, setCash] = useState({
    landBank: 0,
    pocket: 0,
  });

  const [stocks, setStocks] = useState([]);
  
  // 昨日資產 (從後端抓取)
  const [prevDayTotalAssets, setPrevDayTotalAssets] = useState(0);

  // 交割金額暫存 (用於編輯模式)
  const [settlement, setSettlement] = useState({
    landBank: 0,
    pocket: 0
  });

  const [isEditing, setIsEditing] = useState(false);

  /*
  // AI 相關 State
  const [aiAnalysis, setAiAnalysis] = useState("");
  const [isGeneratingAI, setIsGeneratingAI] = useState(false);
  const [isPlayingAudio, setIsPlayingAudio] = useState(false);
  const audioRef = useRef(null);
  */

  // --- API Integration Functions ---

  const apiUrl = apiUrlSetting || API_URL;

  // 1. 抓取資料 (Read)
  const fetchData = async (overrideUrl) => {
    const targetUrl = overrideUrl || apiUrl;
    if (!targetUrl) return;
    setLoading(true);
    try {
      const response = await fetch(`${targetUrl}?action=getData`);
      const data = await response.json();
      
      setStocks(data.stocks);
      setCash(data.cash);
      setPrevDayTotalAssets(data.prevDayTotalAssets);
    } catch (error) {
      console.error("Fetch Data Error:", error);
      alert("讀取資料失敗，請檢查網路或 API URL");
    } finally {
      setLoading(false);
    }
  };

  // 2. 通用後端呼叫 (Write)
  const callBackend = async (payload) => {
    if (!apiUrl) return;
    setSyncing(true);
    try {
      // 使用 text/plain 避免 CORS preflight 問題，後端需用 JSON.parse 解析
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      
      if (result.status === 'success') {
        // 更新成功後，直接使用後端回傳的最新完整資料同步前端
        setStocks(result.data.stocks);
        setCash(result.data.cash);
        setPrevDayTotalAssets(result.data.prevDayTotalAssets);
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      console.error("Backend Sync Error:", error);
      alert("同步失敗: " + error.message);
    } finally {
      setSyncing(false);
    }
  };

  // 初始載入
  useEffect(() => {
    fetchData();
  }, []);

  // --- Calculations ---

  // 1. 現金加總
  const totalCash = cash.landBank + cash.pocket;

  // 2. 股票計算
  const stockDetails = stocks.map(stock => {
    // 若後端還沒抓到 LastPrice (例如剛新增)，暫時用 0 或成本價
    const currentPrice = stock.price || 0;
    const prevPrice = stock.prevPrice || currentPrice; // 若無昨日價，暫用今日價避免除以零

    const marketValue = stock.shares * currentPrice;
    const prevMarketValue = stock.shares * prevPrice;
    
    // 每日損益 ($)
    const dailyDiff = marketValue - prevMarketValue;
    
    // 漲跌幅邏輯
    const dailyDiffPercent = prevMarketValue !== 0 ? ((marketValue - prevMarketValue) / prevMarketValue) * 100 : 0;
    
    // MoM (暫時隨機，後端完整後可實作真實 MoM)
    const momPercent = (Math.random() * 10 - 5).toFixed(2); 

    return {
      ...stock,
      price: currentPrice, // 確保有值
      marketValue,
      prevMarketValue,
      dailyDiff,
      dailyDiffPercent,
      momPercent
    };
  });

  // 3. 總股票市值
  const totalStockValue = stockDetails.reduce((acc, curr) => acc + curr.marketValue, 0);
  
  // 4. 總資產
  const totalAssets = totalCash + totalStockValue;
  
  // 5. 總體每日變化
  const dailyAssetDiff = totalAssets - prevDayTotalAssets;
  const dailyAssetDiffPercent = prevDayTotalAssets !== 0 ? (dailyAssetDiff / prevDayTotalAssets) * 100 : 0;

  // 6. 計算佔比與貢獻度
  const finalStockList = stockDetails.map(stock => ({
    ...stock,
    ratio: totalStockValue !== 0 ? (stock.marketValue / totalStockValue) * 100 : 0,
    contributionPercent: prevDayTotalAssets !== 0 ? (stock.dailyDiff / prevDayTotalAssets) * 100 : 0
  }));

  // 分帳戶統計
  const landBankStockValue = finalStockList.filter(s => s.account === '土銀').reduce((acc, s) => acc + s.marketValue, 0);
  const pocketStockValue = finalStockList.filter(s => s.account === '口袋').reduce((acc, s) => acc + s.marketValue, 0);

  // --- Handlers ---

  const handleAddStock = async () => {
    const newStock = { 
      id: '2330', 
      name: '新持股', 
      type: '未分類', 
      account: '土銀', 
      shares: 0, 
      price: 0
    };
    // 樂觀更新 (Optimistic UI): 先在前端顯示，感覺比較快
    setStocks([...stocks, newStock]); 
    // 背景同步
    await callBackend({ action: 'addStock', stock: newStock });
  };

  const handleRemoveStock = async (indexToRemove) => {
    const targetStock = stocks[indexToRemove];
    if (window.confirm(`確定要刪除 ${targetStock.name} 嗎？`)) {
      // 樂觀更新
      setStocks(stocks.filter((_, index) => index !== indexToRemove));
      // 背景同步
      await callBackend({ action: 'deleteStock', stockId: targetStock.id, account: targetStock.account });
    }
  };

  const updateStockLocal = (index, field, value) => {
    // 只更新本地 State，不打 API，避免打字時頻繁送出請求
    const newStocks = [...stocks];
    newStocks[index] = { ...newStocks[index], [field]: value };
    setStocks(newStocks);
  };

  // 切換編輯模式 / 儲存邏輯
  const toggleEditMode = async () => {
    if (isEditing) {
      // 從 編輯 -> 儲存 : 觸發 API 更新
      // 注意：這裡為了確保資料完整，我們會把所有更動過的股票都送一次更新
      // 但為了配合後端簡單邏輯，我們這裡逐一更新 (量大時可優化為批次更新)
      if (!apiUrl) {
        alert("請先設定 GAS URL");
        return;
      }
      setSyncing(true);
      try {
        // 簡單起見，我們假設使用者可能修改了任何股票，這在少量持股時沒問題
        // 為了效能，我們只對有變動的發送請求會更好，但這邊先做全面同步確保安全
        const promises = stocks.map(stock => 
          fetch(apiUrl, {
            method: 'POST',
             headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action: 'updateStock', stock: stock })
          })
        );
        await Promise.all(promises);
        
        // 全部存完後，重新抓一次確保一致性
        fetchData();
        
      } catch (e) {
        console.error("Save Error", e);
        alert("儲存部分資料時發生錯誤");
      } finally {
        setSyncing(false);
      }
    }
    setIsEditing(!isEditing);
  };

  const handleSettlement = async (account) => {
    const amount = Number(settlement[account]);
    if (amount !== 0) {
      // 樂觀更新
      setCash(prev => ({ ...prev, [account]: prev[account] + amount }));
      setSettlement(prev => ({ ...prev, [account]: 0 }));
      
      // 背景同步
      await callBackend({ action: 'updateCash', account, amount, type: 'add' });
    }
  };

  const saveConnectionSettings = () => {
    const nextApiUrl = apiUrlInput.trim();
    const nextSheetUrl = sheetUrlInput.trim();

    setApiUrlSetting(nextApiUrl);
    setSheetUrlSetting(nextSheetUrl);

    try {
      if (nextApiUrl) localStorage.setItem(STORAGE_KEYS.apiUrl, nextApiUrl);
      else localStorage.removeItem(STORAGE_KEYS.apiUrl);

      if (nextSheetUrl) localStorage.setItem(STORAGE_KEYS.sheetUrl, nextSheetUrl);
      else localStorage.removeItem(STORAGE_KEYS.sheetUrl);
    } catch (error) {
      console.warn("LocalStorage Save Error:", error);
    }

    if (nextApiUrl) {
      fetchData(nextApiUrl);
    }
  };

  const openSheetLink = () => {
    const url = sheetUrlSetting.trim();
    if (!url) {
      alert("請先在連線設定中填入試算表連結");
      return;
    }
    window.open(url, '_blank', 'noopener,noreferrer');
  };

  /*
  // --- Gemini AI Functions (Keep existing logic) ---
  const generateAIInsight = async () => {
    if (!apiKey) {
      alert("請先設定 API Key 才能使用 AI 功能");
      return;
    }

    setIsGeneratingAI(true);
    setAiAnalysis("");
    if (audioRef.current) {
        audioRef.current.pause();
        setIsPlayingAudio(false);
    }

    try {
      const portfolioSummary = {
        totalAssets,
        dailyDiff: dailyAssetDiff,
        dailyDiffPercent: dailyAssetDiffPercent.toFixed(2),
        topGainers: finalStockList
          .filter(s => s.dailyDiff > 0)
          .sort((a, b) => b.dailyDiff - a.dailyDiff)
          .slice(0, 2)
          .map(s => `${s.name}(+${formatMoney(s.dailyDiff)})`),
        topLosers: finalStockList
          .filter(s => s.dailyDiff < 0)
          .sort((a, b) => a.dailyDiff - b.dailyDiff) // sort ascending for negative
          .slice(0, 2)
          .map(s => `${s.name}(${formatMoney(s.dailyDiff)})`),
      };

      const prompt = `
        你是用戶的個人AI理財管家。
        根據以下今日資產數據，請用繁體中文生成一段約80-100字的「今日戰情摘要」。
        數據：總資產 ${formatMoney(portfolioSummary.totalAssets)}，
        今日變化 ${portfolioSummary.dailyDiff > 0 ? '+' : ''}${formatMoney(portfolioSummary.dailyDiff)} (${portfolioSummary.dailyDiffPercent}%)。
        主要獲利：${portfolioSummary.topGainers.join(', ') || '無'}。
        主要虧損：${portfolioSummary.topLosers.join(', ') || '無'}。
        要求：語氣專業幽默，先講總結，再點評個股。如果是賺錢恭喜，賠錢給信心。直接輸出純文字。
      `;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });

      const data = await response.json();
      const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text || "無法生成分析報告。";
      setAiAnalysis(generatedText);

    } catch (error) {
      console.error("AI Error:", error);
      setAiAnalysis("AI 連線錯誤。");
    } finally {
      setIsGeneratingAI(false);
    }
  };

  const playTTS = async () => {
    if (!aiAnalysis) return;
    if (isPlayingAudio && audioRef.current) {
        audioRef.current.pause();
        audioRef.current.currentTime = 0;
        setIsPlayingAudio(false);
        return;
    }
    setIsGeneratingAI(true);
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: aiAnalysis }] }],
                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
            })
        });
        const data = await response.json();
        const audioContent = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
        if (audioContent) {
            const binaryString = atob(audioContent);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            const wavBytes = addWavHeader(bytes, 24000, 1, 16);
            const blob = new Blob([wavBytes], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            if (audioRef.current) {
                audioRef.current.src = url;
                audioRef.current.play();
                setIsPlayingAudio(true);
                audioRef.current.onended = () => setIsPlayingAudio(false);
            }
        }
    } catch (error) { alert("語音生成失敗"); } finally { setIsGeneratingAI(false); }
  };

  // WAV Header Helper
  const addWavHeader = (pcmData, sampleRate, numChannels, bitDepth) => {
    const header = new ArrayBuffer(44);
    const view = new DataView(header);
    const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
    writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcmData.length, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numChannels * (bitDepth / 8), true); view.setUint16(32, numChannels * (bitDepth / 8), true);
    view.setUint16(34, bitDepth, true); writeString(view, 36, 'data'); view.setUint32(40, pcmData.length, true);
    const wavData = new Uint8Array(header.byteLength + pcmData.length);
    wavData.set(new Uint8Array(header), 0); wavData.set(pcmData, header.byteLength);
    return wavData;
  };
  */

  // --- Helpers ---
  const formatMoney = (num) => new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(Math.round(num));
  const formatPercent = (num) => `${Number(num).toFixed(2)}%`;
  
  const getDiffColor = (val) => {
    if (val > 0) return 'text-red-600'; 
    if (val < 0) return 'text-green-600'; 
    return 'text-gray-400';
  };

  if (loading && stocks.length === 0) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50 flex-col gap-3">
        <Loader className="animate-spin text-blue-500" size={32} />
        <p className="text-gray-500 text-sm font-medium">正在連線至鈔能力資料庫...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 font-sans pb-24">
      {/* Invisible Audio Element */}
      {/* <audio ref={audioRef} className="hidden" /> */}

      {/* Header */}
      <header className="bg-white shadow-sm sticky top-0 z-20 border-b border-gray-200">
        <div className="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
          <div>
            <button
              type="button"
              onClick={openSheetLink}
              className="text-xl font-bold text-gray-800 flex items-center gap-2 hover:opacity-80 transition"
              title="開啟試算表連結"
            >
              <span style={{color: COLORS.blue}}>鈔</span> 
              <span style={{color: COLORS.green}}>能力</span>
              <span style={{color: COLORS.red}}>雷達</span>
            </button>
            <div className="flex items-center gap-2">
               <p className="text-xs text-gray-500 flex items-center gap-1">
                <Calendar size={12} /> {dateStr} ({weekDay})
              </p>
              {syncing && <span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded flex items-center gap-1"><RefreshCw size={8} className="animate-spin"/> 同步中</span>}
            </div>
          </div>
          <button 
            onClick={toggleEditMode}
            disabled={syncing}
            className={`p-2 rounded-full transition-all duration-300 ${isEditing ? 'bg-blue-100 text-blue-600 ring-2 ring-blue-400' : 'bg-gray-100 text-gray-600'}`}
          >
            {isEditing ? <Save size={20} /> : <Edit2 size={20} />}
          </button>
        </div>
      </header>

      <main className="max-w-md mx-auto px-4 py-4 space-y-4">

        {/* 連線設定 */}
        <div className="bg-white rounded-2xl shadow-sm p-4 border border-gray-100">
          <h2 className="text-gray-700 font-bold mb-3 flex items-center gap-2">
            <Layers size={18} className="text-blue-500" /> 連線設定
          </h2>
          <div className="space-y-3">
            <div>
              <label className="block text-xs text-gray-500 mb-1">GAS URL (Google Apps Script)</label>
              <input
                type="url"
                className="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-200"
                placeholder="https://script.google.com/macros/s/.../exec"
                value={apiUrlInput}
                onChange={(e) => setApiUrlInput(e.target.value)}
              />
            </div>
            <div>
              <label className="block text-xs text-gray-500 mb-1">試算表連結 (Google Sheets)</label>
              <input
                type="url"
                className="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-200"
                placeholder="https://docs.google.com/spreadsheets/d/..."
                value={sheetUrlInput}
                onChange={(e) => setSheetUrlInput(e.target.value)}
              />
            </div>
            <button
              type="button"
              onClick={saveConnectionSettings}
              className="w-full bg-blue-600 text-white text-xs font-bold py-2 rounded-lg hover:bg-blue-700 transition"
            >
              儲存並連線
            </button>
            <p className="text-[10px] text-gray-400">網址僅儲存在您的瀏覽器中</p>
          </div>
        </div>
        
        {/* ✨ AI 戰情室 */}
        {/*
        {!isEditing && (
          <div className="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl p-4 border border-purple-100 shadow-sm relative overflow-hidden">
             <Sparkles className="absolute -right-4 -top-4 text-purple-200 opacity-50" size={80} />
             <div className="relative z-10">
               <h2 className="text-purple-800 font-bold flex items-center gap-2 mb-2">
                 <Sparkles size={18} className="fill-purple-400 text-purple-600"/>
                 AI 智能理財助理
               </h2>
               
               {aiAnalysis ? (
                 <div className="space-y-3 animate-in fade-in duration-500">
                   <div className="bg-white/80 backdrop-blur-sm p-3 rounded-xl text-sm text-gray-700 leading-relaxed shadow-sm">
                     {aiAnalysis}
                   </div>
                   <div className="flex gap-2">
                     <button 
                       onClick={playTTS}
                       disabled={isGeneratingAI}
                       className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-xs font-bold transition-all ${isPlayingAudio ? 'bg-red-100 text-red-600' : 'bg-purple-600 text-white hover:bg-purple-700'}`}
                     >
                       {isGeneratingAI && isPlayingAudio ? (
                         <Loader className="animate-spin" size={14} />
                       ) : isPlayingAudio ? <><StopCircle size={14} /> 停止播放</> : <><Volume2 size={14} /> 語音播報</>}
                     </button>
                      <button 
                       onClick={generateAIInsight}
                       disabled={isGeneratingAI}
                       className="px-3 py-2 bg-white text-purple-600 border border-purple-200 rounded-xl text-xs font-bold hover:bg-purple-50"
                     >
                       重新分析
                     </button>
                   </div>
                 </div>
               ) : (
                 <div className="flex justify-between items-center">
                   <p className="text-xs text-purple-600/80 max-w-[60%]">
                     讓 AI 根據今日盤後數據，為您生成專屬的投資快報。
                   </p>
                   <button 
                     onClick={generateAIInsight}
                     disabled={isGeneratingAI}
                     className="bg-white text-purple-600 border border-purple-200 shadow-sm px-4 py-2 rounded-xl text-xs font-bold hover:bg-purple-50 flex items-center gap-2 transition-all"
                   >
                     {isGeneratingAI ? <Loader className="animate-spin" size={14} /> : <Sparkles size={14} />}
                     生成分析
                   </button>
                 </div>
               )}
             </div>
          </div>
        )}
        */}

        {/* Block 1: 總體資產 */}
        <div className="bg-white rounded-2xl shadow-sm p-5 border-l-4" style={{borderColor: COLORS.blue}}>
          <div className="flex justify-between items-start mb-2">
            <span className="text-gray-500 text-sm font-medium">總資產淨值</span>
            <span className={`text-sm font-bold flex items-center ${getDiffColor(dailyAssetDiffPercent)}`}>
              {dailyAssetDiff > 0 ? <TrendingUp size={16} className="mr-1"/> : <TrendingDown size={16} className="mr-1"/>}
              {formatPercent(dailyAssetDiffPercent)}
            </span>
          </div>
          <div className="text-3xl font-extrabold text-gray-800 tracking-tight">
            ${formatMoney(totalAssets)}
          </div>
          <div className={`text-sm mt-1 flex items-center gap-2 ${getDiffColor(dailyAssetDiff)}`}>
            <span>今日變化: {dailyAssetDiff > 0 ? '+' : ''}{formatMoney(dailyAssetDiff)}</span>
          </div>
          
          <div className="mt-4 flex h-3 w-full rounded-full overflow-hidden bg-gray-100">
            <div style={{width: `${totalAssets > 0 ? (totalStockValue/totalAssets)*100 : 0}%`, backgroundColor: COLORS.blue}}></div>
            <div style={{width: `${totalAssets > 0 ? (totalCash/totalAssets)*100 : 0}%`, backgroundColor: COLORS.yellow}}></div>
          </div>
          <div className="mt-2 flex justify-between text-xs text-gray-500">
            <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full" style={{background:COLORS.blue}}></div>股票 {totalAssets > 0 ? (totalStockValue/totalAssets*100).toFixed(1) : 0}%</span>
            <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full" style={{background:COLORS.yellow}}></div>現金 {totalAssets > 0 ? (totalCash/totalAssets*100).toFixed(1) : 0}%</span>
          </div>
        </div>

        {/* Block 2: 股票部位 */}
        <div className="bg-white rounded-2xl shadow-sm p-4 border-l-4" style={{borderColor: COLORS.red}}>
          <div className="flex justify-between items-center mb-3">
             <h2 className="text-gray-700 font-bold flex items-center gap-2">
              <PieIcon size={18} className="text-red-500"/> 股票部位
            </h2>
            <span className="text-xs text-gray-400">總市值: {formatMoney(totalStockValue)}</span>
          </div>
         
          <div className="grid grid-cols-2 gap-3 mb-4">
            <div className="bg-red-50 p-3 rounded-xl border border-red-100">
              <div className="text-xs text-gray-500 mb-1">土銀證券</div>
              <div className="font-bold text-gray-800 text-lg">${formatMoney(landBankStockValue)}</div>
            </div>
            <div className="bg-red-50 p-3 rounded-xl border border-red-100">
              <div className="text-xs text-gray-500 mb-1">口袋證券</div>
              <div className="font-bold text-gray-800 text-lg">${formatMoney(pocketStockValue)}</div>
            </div>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="text-xs text-gray-500 bg-gray-50 border-b border-gray-100">
                <tr>
                  <th className="px-1 py-2 font-medium w-1/4">名稱/類別</th>
                  <th className="px-1 py-2 font-medium text-right w-1/4">{isEditing ? '股數/價格' : '淨值'}</th>
                  <th className="px-1 py-2 font-medium text-right w-1/4">每日損益</th>
                  <th className="px-1 py-2 font-medium text-right w-1/4">資產佔比</th>
                  {isEditing && <th className="px-1 py-2 font-medium w-8">刪</th>}
                </tr>
              </thead>
              <tbody>
                {finalStockList.map((stock, index) => (
                  <tr key={index} className="border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors">
                    <td className="px-1 py-3 align-top">
                      {isEditing ? (
                        <div className="flex flex-col gap-1">
                          <input 
                            className="w-full text-xs font-bold border border-gray-300 rounded px-1 py-0.5"
                            value={stock.name}
                            onChange={(e) => updateStockLocal(index, 'name', e.target.value)}
                            placeholder="股名"
                          />
                          <input 
                            className="w-full text-[10px] text-gray-500 border border-gray-300 rounded px-1 py-0.5"
                            value={stock.type}
                            onChange={(e) => updateStockLocal(index, 'type', e.target.value)}
                            placeholder="類別"
                          />
                           <input 
                            className="w-full text-[10px] text-gray-500 border border-gray-300 rounded px-1 py-0.5"
                            value={stock.id}
                            onChange={(e) => updateStockLocal(index, 'id', e.target.value)}
                            placeholder="代號"
                          />
                        </div>
                      ) : (
                        <div>
                          <div className="font-bold text-gray-800">{stock.name}</div>
                          <div className="text-[10px] bg-gray-100 inline-block px-1 rounded text-gray-500 mt-0.5">{stock.type}</div>
                          <div className="text-[10px] text-gray-400">{stock.id}</div>
                        </div>
                      )}
                    </td>

                    <td className="px-1 py-3 text-right align-top font-mono">
                      {isEditing ? (
                         <div className="flex flex-col gap-1 items-end">
                           <div className="flex items-center gap-1">
                             <span className="text-[10px] text-gray-400">股</span>
                             <input 
                              type="number" 
                              className="w-16 border border-blue-300 rounded px-1 text-right bg-blue-50 focus:ring-1 focus:ring-blue-500 outline-none"
                              value={stock.shares}
                              onChange={(e) => updateStockLocal(index, 'shares', Number(e.target.value))}
                            />
                           </div>
                           <div className="flex items-center gap-1">
                             <span className="text-[10px] text-gray-400">$</span>
                             <input 
                              type="number" 
                              className="w-16 border border-gray-300 rounded px-1 text-right bg-white focus:ring-1 focus:ring-blue-500 outline-none"
                              value={stock.price}
                              onChange={(e) => updateStockLocal(index, 'price', Number(e.target.value))}
                            />
                           </div>
                        </div>
                      ) : (
                        <div>
                           <div className="font-medium text-gray-800">${formatMoney(stock.marketValue)}</div>
                           {stock.shares === 0 && <span className="text-[10px] text-gray-400">(已清倉)</span>}
                        </div>
                      )}
                    </td>

                    <td className={`px-1 py-3 text-right align-top font-medium ${getDiffColor(stock.dailyDiff)}`}>
                      <div className="flex flex-col items-end">
                        <span>{stock.dailyDiff > 0 ? '+' : ''}{formatMoney(stock.dailyDiff)}</span>
                        {stock.shares > 0 && Math.abs(stock.contributionPercent) > 0.01 && (
                           <span className="text-[10px] opacity-80">
                             貢獻 {stock.contributionPercent > 0 ? '+' : ''}{stock.contributionPercent.toFixed(2)}%
                           </span>
                        )}
                      </div>
                    </td>

                    <td className="px-1 py-3 text-right align-top">
                      <div className="font-medium text-gray-700">{formatPercent(stock.ratio)}</div>
                      <div className={`text-[10px] ${getDiffColor(Number(stock.momPercent))}`}>
                        MoM {stock.momPercent}%
                      </div>
                    </td>

                    {isEditing && (
                      <td className="px-1 py-3 align-middle text-center">
                        <button 
                          onClick={() => handleRemoveStock(index)}
                          className="text-red-400 hover:text-red-600 p-1"
                        >
                          <Trash2 size={16} />
                        </button>
                      </td>
                    )}
                  </tr>
                ))}
              </tbody>
            </table>
            
            {isEditing && (
              <button 
                onClick={handleAddStock}
                className="w-full mt-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 hover:border-blue-400 hover:text-blue-500 flex items-center justify-center gap-2 transition-colors"
              >
                <Plus size={18} /> 新增持股
              </button>
            )}
          </div>
        </div>

        {/* Block 3: 現金部位 */}
        <div className="bg-white rounded-2xl shadow-sm p-4 border-l-4" style={{borderColor: COLORS.yellow}}>
           <h2 className="text-gray-700 font-bold mb-3 flex items-center gap-2">
            <DollarSign size={18} className="text-yellow-500"/> 現金部位
            <span className="text-xs font-normal text-gray-400 ml-auto">總現金: {formatMoney(totalCash)}</span>
          </h2>
          
           <div className="space-y-3">
            <div className="p-3 bg-yellow-50 rounded-xl">
              <div className="flex justify-between items-center mb-1">
                <span className="text-gray-600 font-medium flex items-center gap-1">
                  土銀帳戶
                  {isEditing && <span className="text-[10px] bg-blue-100 text-blue-600 px-1 rounded">編輯中</span>}
                </span>
                <span className="font-bold text-gray-800 text-lg">${formatMoney(cash.landBank)}</span>
              </div>
              
              {isEditing && (
                <div className="mt-2 flex items-center gap-2 bg-white p-2 rounded-lg border border-yellow-200">
                  <Calculator size={16} className="text-gray-400"/>
                  <input 
                    type="number" 
                    placeholder="輸入交割金額 (+/-)"
                    className="flex-1 text-sm outline-none text-gray-700 placeholder-gray-300"
                    value={settlement.landBank || ''}
                    onChange={(e) => setSettlement({...settlement, landBank: e.target.value})}
                  />
                  <button 
                    onClick={() => handleSettlement('landBank')}
                    className="bg-yellow-500 text-white text-xs px-3 py-1.5 rounded-md hover:bg-yellow-600 font-medium"
                  >
                    更新餘額
                  </button>
                </div>
              )}
            </div>

            <div className="p-3 bg-yellow-50 rounded-xl">
              <div className="flex justify-between items-center mb-1">
                <span className="text-gray-600 font-medium flex items-center gap-1">
                  口袋帳戶
                   {isEditing && <span className="text-[10px] bg-blue-100 text-blue-600 px-1 rounded">編輯中</span>}
                </span>
                <span className="font-bold text-gray-800 text-lg">${formatMoney(cash.pocket)}</span>
              </div>

               {isEditing && (
                <div className="mt-2 flex items-center gap-2 bg-white p-2 rounded-lg border border-yellow-200">
                   <Calculator size={16} className="text-gray-400"/>
                  <input 
                    type="number" 
                    placeholder="輸入交割金額 (+/-)"
                    className="flex-1 text-sm outline-none text-gray-700 placeholder-gray-300"
                    value={settlement.pocket || ''}
                    onChange={(e) => setSettlement({...settlement, pocket: e.target.value})}
                  />
                  <button 
                    onClick={() => handleSettlement('pocket')}
                    className="bg-yellow-500 text-white text-xs px-3 py-1.5 rounded-md hover:bg-yellow-600 font-medium"
                  >
                    更新餘額
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* 底部操作提示 */}
        {isEditing && (
          <div className="fixed bottom-4 left-0 right-0 px-4 z-30">
             <div className="bg-blue-600 text-white p-3 rounded-xl shadow-xl flex justify-between items-center animate-in slide-in-from-bottom duration-300">
               <span className="font-bold text-sm">編輯模式開啟中</span>
               <button 
                onClick={toggleEditMode}
                className="bg-white text-blue-600 px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm flex items-center gap-1"
               >
                 {syncing ? '同步中...' : '完成並儲存'}
               </button>
             </div>
          </div>
        )}

      </main>
    </div>
  );
};

export default PortfolioTracker;
